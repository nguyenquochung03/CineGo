@model CineGo.DTO.Movie.MovieDTO

@{
    ViewData["Title"] = Model.Title;
    double ratingValue = 0;
    double.TryParse(Model.Rating, out ratingValue);
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

<style>
    .movie-details-container {
        font-family: 'Montserrat', 'Roboto', sans-serif;
        color: #555;
        line-height: 1.6;
        margin: 0 2rem
    }

    /* ========== CỘT TRÁI ========== */
    .movie-left {
        padding-right: 1.5rem;
    }

        .movie-left .poster-wrapper {
            width: 100%;
            max-height: 600px;
            overflow: hidden;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.25), 0 6px 18px rgba(220, 20, 60, 0.25);
        }


            .movie-left .poster-wrapper img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.4s ease;
                border: 2px solid rgba(220, 20, 60, 0.55);
                border-radius: 6px;
            }

    .btn-book {
        background: linear-gradient(135deg, #DC143C, #ff4b2b);
        color: #fff;
        border: none;
        padding: 8px 0;
        margin: 6px 0;
        font-size: 0.9rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.25s ease;
        text-align: center;
        width: 100%;
        margin-top: 0.8rem;
    }

        .btn-book:hover {
            box-shadow: 0 6px 18px rgba(255, 77, 77, 0.55);
            transform: translateY(-2px);
        }
    /* ========== CỘT PHẢI ========== */
    .movie-right .movie-title {
        font-size: 2.2rem;
        font-weight: 800;
        color: #DC143C;
        margin-bottom: 0.6rem;
    }

    .movie-rating {
        display: flex;
        flex-direction: row;
    }

        .movie-rating .stars i {
            font-size: 1.3rem;
            margin-right: 2px;
            color: #DC143C;
        }

        .movie-rating .rating-score {
            font-weight: 500;
            color: #555;
        }

    .movie-meta {
        font-size: 0.95rem;
        color: #555;
    }

    .age-badge {
        background-color: #ff4d4f;
        color: #fff;
        padding: 3px 8px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .movie-basic p {
        margin-bottom: 0.3rem;
        font-size: 0.96rem;
    }

    .movie-basic strong {
        color: #DC143C;
    }
    /* ========== TÓM TẮT NỘI DUNG ========== */
    .movie-synopsis {
        margin-top: 1.5rem;
    }

        .movie-synopsis h5 {
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #DC143C;
        }

    /* ===============================
           GIAO DIỆN ĐÁNH GIÁ PHIM (Reviews)
        ================================= */
    .review-box {
        margin-top: 3rem;
    }

    /* Header */
    .review-header {
        margin-bottom: 1rem;
    }

        .review-header h4 {
            font-weight: 700;
            color: #DC143C;
        }

    #charCount {
        font-size: 0.9rem;
        color: #777;
    }

    /* ========== BỐ CỤC CHÍNH 3 CỘT ========== */
    .review-panel {
        display: grid;
        grid-template-columns: 180px 1fr 150px;
        align-items: stretch;
        border-radius: 8px;
        overflow: hidden;
        background-color: #fff;
        border: 1px solid rgba(220, 20, 60, 0.25);
    }

    /* --- Cột trái --- */
    .review-left {
        background-color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

        .review-left p {
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.95rem;
        }

    .rating-stars {
        display: inline-flex;
        gap: 4px;
    }

        .rating-stars i {
            font-size: 1.3rem;
            color: #FFB300;
            cursor: pointer;
            transition: transform 0.15s ease, color 0.15s ease;
        }

            .rating-stars i.hover-full,
            .rating-stars i.selected-full {
                color: #FF4500;
            }

            .rating-stars i.hover-half::before,
            .rating-stars i.selected-half::before {
                content: "\f588";
                font-family: bootstrap-icons;
                color: #FF4500;
                position: absolute;
            }

            .rating-stars i:hover {
                transform: scale(1.1);
            }

    .rating-score {
        display: block;
        margin-top: 0.25rem;
        color: #555;
        font-weight: 600;
    }

    /* --- Cột giữa --- */
    .review-middle {
        border-right: 1px solid rgba(220, 20, 60, 0.25);
        border-left: 1px solid rgba(220, 20, 60, 0.25);
        padding: 0.8rem;
    }

    .review-textarea {
        width: 100%;
        height: 100%;
        min-height: 70px;
        font-size: 0.95rem;
        resize: none;
        border: none;
        outline: none;
        box-shadow: none;
        transition: none;
    }

        .review-textarea:focus,
        .review-textarea:active {
            resize: none;
            border: none;
            outline: none;
            box-shadow: none;
            transition: none;
        }

    /* --- Cột phải --- */
    .review-right {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .btn-review-submit {
        background: linear-gradient(135deg, #DC143C, #ff4b2b);
        color: #fff;
        border: none;
        padding: 8px 18px;
        margin: 6px 0;
        font-size: 0.9rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.25s ease;
        text-align: center;
        border-radius: 0 0 0 0;
    }

        .btn-review-submit:hover {
            box-shadow: 0 6px 18px rgba(255, 77, 77, 0.55);
        }

    /* ===============================
           DANH SÁCH REVIEW NGƯỜI DÙNG
        ================================= */
    .review-item {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #eee;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .review-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .review-item strong {
            font-size: 1rem;
        }

        .review-item .score {
            font-size: 0.9rem;
            color: #777;
            margin-left: 4px;
        }

        .review-item p {
            margin-top: 0.5rem;
            font-size: 0.95rem;
        }

    .review-meta {
        font-size: 0.85rem;
        color: #888;
    }

    .review-warning {
        display: flex;
        flex-direction: column;
        background-color: #fff;
        border-radius: 8px;
        padding: 0.8rem;
        gap: 0.5rem;
    }

        .review-warning .review-warning {
            font-weight: 600;
            font-size: 1rem;
        }

        .review-warning .review-warning-body {
            display: flex;
            flex-direction: column;
            gap: 0rem;
            margin: 0 0 0 0.6rem;
        }

            .review-warning .review-warning-body p {
                font-size: 0.95rem;
                color: #555;
                margin: 0 0 0.1rem 0;
            }

    /* ===============================
           RESPONSIVE
        ================================= */
    @@media (max-width: 992px) {
        .movie-right .movie-title {
            font-size: 1.8rem;
            text-align: center;
        }

        .movie-left {
            margin-bottom: 1.5rem;
        }
    }

    @@media (max-width: 768px) {
        .review-panel {
            grid-template-columns: 1fr;
        }

        .review-left {
            border-right: none;
            border-bottom: 1px solid #e0e0e0;
        }

        .movie-left {
            padding-right: 10px;
        }

        .review-middle {
            border-top: 1px solid rgba(220, 20, 60, 0.25);
            border-bottom: 1px solid rgba(220, 20, 60, 0.25);
            border-left: none;
            border-right: none;
            padding: 0.8rem;
        }

        .review-right {
            height: 48px;
        }

        .btn-review-submit {
            font-size: 1rem;
        }

        .review-textarea {
            min-height: 80px;
        }
    }

    @@media (max-width: 576px) {
        .movie-details-container {
            margin: 0 1rem
        }

        .movie-title {
            font-size: 1.6rem;
        }

        .btn-book {
            font-size: 1rem;
        }

        .review-header {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
    }
</style>

<div class="movie-details-container">
    <div class="row">
        <!-- BÊN TRÁI -->
        <div class="col-md-3 text-center movie-left">
            <div class="poster-wrapper">
                <img src="@(Model.Posters?.FirstOrDefault()?.Url ?? "/images/default-movie.png")"
                     alt="@Model.Title"
                     class="movie-poster" />
            </div>
            <button class="btn btn-book"><i class="bi bi-ticket-perforated-fill"></i> Đặt vé ngay</button>
        </div>

        <!-- BÊN PHẢI -->
        <div class="col-md-8 movie-right">
            <h2 class="movie-title">@Model.Title</h2>

            <!-- Rating trung bình -->
            <div class="movie-rating mb-2">
                <div class="stars d-inline-block me-2">
                    @{
                        int stars = (int)Math.Round(ratingValue / 2);
                        for (int i = 1; i <= 5; i++)
                        {
                            <i class="bi @(i <= stars ? "bi-star-fill text-warning" : "bi-star text-secondary")"></i>
                        }
                    }
                </div>
                <span class="rating-score">@ratingValue.ToString("0.0") / 10</span>
            </div>

            <div class="movie-meta text-muted mb-3">
                <span class="age-badge">@Model.AgeLimit+</span> |
                <span>Phát hành: @Model.ReleaseDate.ToString("dd/MM/yyyy")</span>
            </div>

            <div class="movie-basic">
                <p><strong>Thông tin cơ bản:</strong> @(string.IsNullOrWhiteSpace(Model.Slug) ? "Chưa có" : Model.Slug)</p>
                <p><strong>Thời lượng:</strong> @(Model.Runtime > 0 ? $"{Model.Runtime} phút" : "Đang cập nhật")</p>
            </div>
        </div>
    </div>

    <div class="movie-synopsis mt-4">
        <h5>Tóm tắt nội dung</h5>
        <p>@(string.IsNullOrWhiteSpace(Model.Synopsis) ? "Chưa có nội dung tóm tắt cho phim này." : Model.Synopsis)</p>
    </div>

    <!-- PHẦN ĐÁNH GIÁ -->
    <div class="review-box">
        <div class="review-header d-flex justify-content-between align-items-center">
            <h4 class="fw-bold mb-0">Xếp hạng và đánh giá phim</h4>
            <span id="charCount" class="text-muted small">0 / 220 Ký Tự</span>
        </div>

        <div class="review-panel">
            <!-- Cột trái -->
            <div class="review-left text-center">
                <p class="fw-semibold mb-2">Xếp hạng</p>
                <div class="rating-group">
                    <div class="rating-stars mb-2">
                        <i class="bi bi-star" data-value="2"></i>
                        <i class="bi bi-star" data-value="4"></i>
                        <i class="bi bi-star" data-value="6"></i>
                        <i class="bi bi-star" data-value="8"></i>
                        <i class="bi bi-star" data-value="10"></i>
                    </div>
                    <span class="rating-score">0 điểm</span>
                </div>
            </div>

            <!-- Cột giữa -->
            <div class="review-middle">
                <textarea id="reviewContent"
                          class="form-control review-textarea"
                          rows="2"
                          maxlength="220"
                          placeholder="Các đánh giá phim có thể được viết sau khi đăng nhập."></textarea>
            </div>

            <!-- Cột phải -->
            <div class="review-right">
                <button class="btn btn-review-submit w-100 h-100">BÌNH LUẬN</button>
            </div>
        </div>
    </div>

    <hr />

    <div id="reviewList">
        @if (Model.Reviews != null && Model.Reviews.Any())
        {
            foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
            {
                double reviewRating = 0;
                double.TryParse(review.Rating.ToString(), out reviewRating);
                int rStars = (int)Math.Round(reviewRating / 2);

                <div class="review-item mb-4 p-3 border rounded shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Khách</strong>
                        <span>
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="bi @(i <= rStars ? "bi-star-fill text-warning" : "bi-star text-muted")"></i>
                            }
                            <span class="score">(@reviewRating.ToString("0.0") / 10)</span>
                        </span>
                    </div>
                    <p class="mt-2">@review.Content</p>
                    <div class="review-meta text-muted small">
                        <span>@review.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span> ·
                        <span class="like-button" data-liked="@review.Likes.ToString().ToLower()">
                            @* <span class="like-icon">@((review.Likes) ? "❤️" : "🤍")</span> *@
                            <span>@review.Likes lượt thích</span>
                        </span>
                    </div>
                    <hr />
                </div>
            }
        }
        else
        {
            <p class="text-muted text-center">Chưa có đánh giá nào cho phim này.</p>
        }
    </div>

    <div class="review-warning">
        <div class="review-warning-header">
            <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i> <strong>Lưu ý</strong>
        </div>
        <div class="review-warning-body">
            <p>Mỗi tài khoản chỉ được đánh giá một lần cho mỗi lượt truy cập.</p>
            <p>Bạn phải là <strong>thành viên</strong> và đã mua vé xem phim để tham gia đánh giá.<br /></p>
            <p>Bạn có thể kiểm tra lại phần đánh giá của mình trong <strong>My Cinema</strong>.</p>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/movie-details.js"></script>
}
