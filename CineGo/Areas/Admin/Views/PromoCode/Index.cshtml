@model CineGo.DTO.Common.PagedResult<CineGo.DTO.PromoCode.PromoCodeDTO>
@{
    ViewData["Title"] = "Quản lý Mã Giảm Giá";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/PromoCode.css" />

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Danh sách Mã Giảm Giá</h5>
        <button class="btn btn-sm btn-primary" onclick="showPromoModal(0)"><i class="bi bi-plus-circle me-1"></i> Thêm Mã</button>
    </div>

    <div class="card-body">
        <form asp-action="Index" method="get" class="mb-3">
            <div class="input-group">
                <input type="text" name="searchCode" class="form-control" placeholder="Tìm kiếm theo mã giảm giá..." value="@ViewBag.SearchCode" />
                <button type="submit" class="btn btn-outline-red-orange">Tìm kiếm</button>
                @if (!string.IsNullOrWhiteSpace(ViewBag.SearchCode))
                {
                    <a asp-action="Index" class="btn btn-outline-danger">Xóa tìm kiếm</a>
                }
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Mã</th>
                        <th>Loại</th>
                        <th>Giá trị</th>
                        <th>Từ ngày</th>
                        <th>Đến ngày</th>
                        <th>Trạng thái</th>
                        <th class="text-end" style="width:130px;">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items != null && Model.Items.Any())
                    {
                        foreach (var p in Model.Items)
                        {
                            <tr>
                                <td>@p.Code</td>
                                <td>@(p.DiscountType == "Percent" ? "Phần trăm" : "Số tiền")</td>
                                <td>@(p.DiscountType == "Percent" ? p.Value + "%" : p.Value.ToString("N0") + " đ")</td>
                                <td>@p.ValidFrom.ToString("dd/MM/yyyy")</td>
                                <td>@p.ValidTo.ToString("dd/MM/yyyy")</td>
                                <td>
                                    @if (p.IsActive)
                                    {
                                        <span class="badge bg-success">Hoạt động</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Ngừng</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-warning btn-sm text-white" onclick="showPromoModal(@p.Id)">
                                        <i class="bi bi-pencil-fill me-1"></i> Sửa
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deletePromo(@p.Id, '@p.Code')">
                                        <i class="bi bi-trash-fill me-1"></i> Xóa
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center text-muted">Không có dữ liệu</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-3 text-center">
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <button type="button"
                        class="btn btn-sm @(i == Model.Page ? "btn-red-orange" : "btn-outline-red-orange")"
                        onclick="window.location.href='@Url.Action("Index", new { page = i, searchCode = ViewBag.SearchCode })'">
                    @i
                </button>
            }
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="promoModal" tabindex="-1" aria-labelledby="promoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-red-orange text-white">
                <h5 class="modal-title" id="promoModalLabel">Thêm/Sửa Mã Giảm Giá</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="promoFormContainer">Đang tải...</div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $('#promoModal').on('shown.bs.modal', function () {
            $(this).find('input:visible:first').focus();
        });

        function showPromoModal(id) {
            var title = id === 0 ? "Thêm Mã Giảm Giá" : "Chỉnh Sửa Mã Giảm Giá";
            $("#promoModalLabel").text(title);
            $("#promoFormContainer").html("Đang tải...");

            $.ajax({
                url: '@Url.Action("GetForm", "PromoCode")',
                type: 'GET',
                data: { id: id },
                success: function (html) {
                    $("#promoFormContainer").html(html);
                    $('#promoModal').modal('show');
                },
                error: function () {
                    $("#promoFormContainer").html('<div class="alert alert-danger">Không thể tải form.</div>');
                }
            });
        }

        function submitPromoForm(form) {
            var formData = new FormData(form);
            $('.validation-summary-errors').remove();

            $.ajax({
                url: '@Url.Action("Save", "PromoCode")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (result) {
                    if (result.success) {
                        $('#promoModal').modal('hide');
                        window.location.reload();
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 400 || xhr.status === 200) {
                        $("#promoFormContainer").html(xhr.responseText);
                        $.validator.unobtrusive.parse(form);
                    } else {
                        alert("Lỗi server: " + xhr.statusText);
                    }
                }
            });

            return false;
        }

        function deletePromo(id, code) {
            if (confirm(`Bạn có chắc chắn muốn xóa mã "${code}"?`)) {
                $.post('@Url.Action("Delete", "PromoCode")', { id: id })
                    .done(function (result) {
                        if (result.success) {
                            window.location.reload();
                        } else {
                            alert(result.message || "Xóa thất bại.");
                        }
                    })
                    .fail(function () {
                        alert("Lỗi server khi xóa.");
                    });
            }
        }
    </script>
}
